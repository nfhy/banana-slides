name: Full Test Suite

# Full tests run in these cases:
# 1. Push to main/develop branch (direct push, not from PR merge)
# 2. PR labeled with ready-for-test
# 3. Manual trigger (workflow_dispatch)
#
# Note: PR merge does NOT trigger tests again to avoid duplication
# (PR should be tested via ready-for-test label before merging)
on:
  push:
    branches: [ main, develop ]
  pull_request:
    types: [labeled]
    branches: [ main, develop ]
  workflow_dispatch:  # 允许手动触发

# Cancel old builds on the same branch
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # ================================
  # Backend Tests
  # ================================
  backend-unit-test:
    name: Backend Unit Tests
    runs-on: ubuntu-latest
    # Run in these cases: direct push to main/develop, ready-for-test label, or manual trigger
    if: |
      github.event_name == 'push' ||
      github.event_name == 'workflow_dispatch' ||
      (github.event_name == 'pull_request' && github.event.action == 'labeled' && github.event.label.name == 'ready-for-test')
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Python environment
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
          cache: 'pip'
      
      - name: Install uv package manager
        run: |
          curl -LsSf https://astral.sh/uv/install.sh | sh
          echo "$HOME/.cargo/bin" >> $GITHUB_PATH
      
      - name: Install dependencies (with test extras)
        run: |
          uv sync --extra test
      
      - name: Run unit tests
        run: |
          cd backend
          uv run pytest tests/unit -v --cov=. --cov-report=xml --cov-report=term
        continue-on-error: false
      
      - name: Upload coverage report
        uses: codecov/codecov-action@v4
        with:
          file: ./backend/coverage.xml
          flags: backend
          name: backend-coverage

  backend-integration-test:
    name: Backend Integration Tests
    runs-on: ubuntu-latest
    needs: backend-unit-test
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Python environment
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
      
      - name: Install uv
        run: |
          curl -LsSf https://astral.sh/uv/install.sh | sh
          echo "$HOME/.cargo/bin" >> $GITHUB_PATH
      
      - name: Install dependencies (with test extras)
        run: uv sync --extra test
      
      - name: Run integration tests
        run: |
          cd backend
          uv run pytest tests/integration -v
        env:
          # Use mock mode, no real API dependency
          TESTING: true
          GOOGLE_API_KEY: ${{ secrets.GOOGLE_API_KEY || 'mock-api-key-for-testing' }}

  # ================================
  # Frontend Tests
  # ================================
  frontend-test:
    name: Frontend Tests
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js environment
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json
      
      - name: Install dependencies
        run: |
          cd frontend
          npm ci
      
      - name: Lint check
        run: |
          cd frontend
          npm run lint
      
      - name: Run unit tests
        run: |
          cd frontend
          npm test -- --run --coverage
        continue-on-error: false
      
      - name: Upload coverage report
        uses: codecov/codecov-action@v4
        with:
          file: ./frontend/coverage/coverage-final.json
          flags: frontend
          name: frontend-coverage
      
      - name: Build check
        run: |
          cd frontend
          npm run build

  # ================================
  # Docker Environment Tests
  # ================================
  docker-test:
    name: Docker Environment Tests
    runs-on: ubuntu-latest
    needs: [backend-integration-test, frontend-test]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup environment variables
        run: |
          # Use generic script to automatically handle all environment variable replacements
          chmod +x scripts/setup-env-from-secrets.sh
          ./scripts/setup-env-from-secrets.sh
        env:
          # Export all Secrets as environment variables (script will auto-detect and replace)
          AI_PROVIDER_FORMAT: ${{ secrets.AI_PROVIDER_FORMAT }}
          GOOGLE_API_KEY: ${{ secrets.GOOGLE_API_KEY }}
          GOOGLE_API_BASE: ${{ secrets.GOOGLE_API_BASE }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          OPENAI_API_BASE: ${{ secrets.OPENAI_API_BASE }}
          OPENAI_TIMEOUT: ${{ secrets.OPENAI_TIMEOUT }}
          OPENAI_MAX_RETRIES: ${{ secrets.OPENAI_MAX_RETRIES }}
          TEXT_MODEL: ${{ secrets.TEXT_MODEL }}
          IMAGE_MODEL: ${{ secrets.IMAGE_MODEL }}
          LOG_LEVEL: ${{ secrets.LOG_LEVEL }}
          FLASK_ENV: ${{ secrets.FLASK_ENV }}
          SECRET_KEY: ${{ secrets.SECRET_KEY }}
          PORT: ${{ secrets.PORT }}
          CORS_ORIGINS: ${{ secrets.CORS_ORIGINS }}
          MAX_DESCRIPTION_WORKERS: ${{ secrets.MAX_DESCRIPTION_WORKERS }}
          MAX_IMAGE_WORKERS: ${{ secrets.MAX_IMAGE_WORKERS }}
          MINERU_TOKEN: ${{ secrets.MINERU_TOKEN }}
          MINERU_API_BASE: ${{ secrets.MINERU_API_BASE }}
          IMAGE_CAPTION_MODEL: ${{ secrets.IMAGE_CAPTION_MODEL }}
          OUTPUT_LANGUAGE: ${{ secrets.OUTPUT_LANGUAGE }}
      
      - name: Build Docker images
        run: |
          docker-compose build --no-cache
      
      - name: Start services
        run: |
          docker-compose up -d
          echo "Waiting for services to be ready..."
          sleep 20
      
      - name: Health check
        run: |
          # Backend health check
          echo "Checking backend..."
          for i in {1..30}; do
            if curl -f http://localhost:5000/health; then
              echo "Backend started successfully"
              break
            fi
            echo "Waiting for backend... ($i/30)"
            sleep 2
          done
          
          # Frontend health check
          echo "Checking frontend..."
          for i in {1..30}; do
            if curl -f http://localhost:3000; then
              echo "Frontend started successfully"
              break
            fi
            echo "Waiting for frontend... ($i/30)"
            sleep 2
          done
      
      - name: Run Docker environment tests
        run: |
          chmod +x scripts/test_docker_environment.sh
          AUTO_CLEANUP=false ./scripts/test_docker_environment.sh
      
      - name: View container logs (on failure)
        if: failure()
        run: |
          echo "=== Backend Logs ==="
          docker-compose logs backend
          echo "=== Frontend Logs ==="
          docker-compose logs frontend
      
      - name: Cleanup environment
        if: always()
        run: |
          docker-compose down -v
          docker system prune -f

  # ================================
  # E2E Tests
  # ================================
  e2e-test:
    name: End-to-End Tests
    runs-on: ubuntu-latest
    needs: docker-test
    # Note: Full E2E tests use Gemini format only
    # OpenAI format compatibility is verified in backend-integration-test (equivalent substitution principle)
    env:
      # Set environment variable from secret for use in if conditions
      # (secrets cannot be used directly in if conditions)
      GOOGLE_API_KEY: ${{ secrets.GOOGLE_API_KEY }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
      
      - name: Install Playwright
        run: |
          npm install -D @playwright/test
          npx playwright install --with-deps chromium
      
      - name: Setup environment (with real API key)
        run: |
          # Use generic script to automatically handle all environment variable replacements
          chmod +x scripts/setup-env-from-secrets.sh
          ./scripts/setup-env-from-secrets.sh
          
          # E2E tests use Gemini format (full flow testing)
          echo "E2E tests using Gemini format"
          grep "^AI_PROVIDER_FORMAT=" .env
        env:
          # Export all Secrets as environment variables (script will auto-detect and replace)
          # E2E tests fixed to use Gemini format
          AI_PROVIDER_FORMAT: gemini
          GOOGLE_API_KEY: ${{ secrets.GOOGLE_API_KEY }}
          GOOGLE_API_BASE: ${{ secrets.GOOGLE_API_BASE }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          OPENAI_API_BASE: ${{ secrets.OPENAI_API_BASE }}
          OPENAI_TIMEOUT: ${{ secrets.OPENAI_TIMEOUT }}
          OPENAI_MAX_RETRIES: ${{ secrets.OPENAI_MAX_RETRIES }}
          TEXT_MODEL: ${{ secrets.TEXT_MODEL }}
          IMAGE_MODEL: ${{ secrets.IMAGE_MODEL }}
          LOG_LEVEL: ${{ secrets.LOG_LEVEL }}
          FLASK_ENV: ${{ secrets.FLASK_ENV }}
          SECRET_KEY: ${{ secrets.SECRET_KEY }}
          PORT: ${{ secrets.PORT }}
          CORS_ORIGINS: ${{ secrets.CORS_ORIGINS }}
          MAX_DESCRIPTION_WORKERS: ${{ secrets.MAX_DESCRIPTION_WORKERS }}
          MAX_IMAGE_WORKERS: ${{ secrets.MAX_IMAGE_WORKERS }}
          MINERU_TOKEN: ${{ secrets.MINERU_TOKEN }}
          MINERU_API_BASE: ${{ secrets.MINERU_API_BASE }}
          IMAGE_CAPTION_MODEL: ${{ secrets.IMAGE_CAPTION_MODEL }}
          OUTPUT_LANGUAGE: ${{ secrets.OUTPUT_LANGUAGE }}
      
      - name: Start Docker environment
        run: |
          docker-compose up -d
          sleep 25
      
      - name: Health check
        run: |
          # Wait for services to be fully ready
          for i in {1..30}; do
            if curl -f http://localhost:5000/health && curl -f http://localhost:3000; then
              echo "Services are ready"
              break
            fi
            echo "Waiting for services to start... ($i/30)"
            sleep 2
          done
      
      - name: Run basic E2E tests
        run: |
          # Run basic UI tests (no real API dependency)
          npx playwright test home.spec.ts create-ppt.spec.ts
        env:
          CI: true
        continue-on-error: false
      
      - name: Run full flow E2E tests (requires real API)
        if: env.GOOGLE_API_KEY != ''
        run: |
          # Run full flow tests (from creation to PPT export)
          # Using Gemini format for full flow testing
          echo "Full E2E test - Gemini format"
          npx playwright test api-full-flow.spec.ts --workers=1
        env:
          CI: true
        timeout-minutes: 15
        continue-on-error: false
      
      - name: Skip full flow test
        if: env.GOOGLE_API_KEY == ''
        run: |
          echo "Skipping full flow E2E test"
          echo "Reason: GOOGLE_API_KEY not configured"
          echo "Note: OpenAI format compatibility is verified in integration tests"
      
      - name: Upload test report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report
          path: playwright-report/
          retention-days: 7
      
      - name: Upload failure screenshots
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-screenshots
          path: test-results/
          retention-days: 7
      
      - name: Cleanup
        if: always()
        run: docker-compose down -v

  # ================================
  # Security Scan
  # ================================
  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Backend dependency security scan
        run: |
          pip install safety
          safety check --json || echo "Security vulnerabilities found (warning)"
        continue-on-error: true
      
      - name: Frontend dependency security scan
        run: |
          cd frontend
          npm audit --audit-level=moderate || echo "Security vulnerabilities found (warning)"
        continue-on-error: true
      
      - name: Dockerfile security scan
        uses: hadolint/hadolint-action@v3.1.0
        with:
          dockerfile: backend/Dockerfile
        continue-on-error: true

  # ================================
  # Test Summary
  # ================================
  test-summary:
    name: Test Summary
    runs-on: ubuntu-latest
    needs: [backend-unit-test, backend-integration-test, frontend-test, docker-test, e2e-test, security-scan]
    if: always()
    
    steps:
      - name: Output test results
        run: |
          echo "================================="
          echo "CI/CD Test Complete"
          echo "================================="
          echo ""
          echo "Test Results:"
          echo "  Backend unit tests: ${{ needs.backend-unit-test.result }}"
          echo "  Backend integration tests: ${{ needs.backend-integration-test.result }}"
          echo "  Frontend tests: ${{ needs.frontend-test.result }}"
          echo "  Docker environment tests: ${{ needs.docker-test.result }}"
          echo "  E2E tests: ${{ needs.e2e-test.result }}"
          echo "  Security scan: ${{ needs.security-scan.result }}"
          echo ""
      
      - name: Check if all tests passed
        if: |
          needs.backend-unit-test.result != 'success' ||
          needs.backend-integration-test.result != 'success' ||
          needs.frontend-test.result != 'success' ||
          needs.docker-test.result != 'success' ||
          needs.e2e-test.result != 'success'
        run: |
          echo "Some tests failed, please check the logs"
          exit 1
      
      - name: All tests passed
        if: |
          needs.backend-unit-test.result == 'success' &&
          needs.backend-integration-test.result == 'success' &&
          needs.frontend-test.result == 'success' &&
          needs.docker-test.result == 'success' &&
          needs.e2e-test.result == 'success'
        run: |
          echo "All tests passed! Ready to merge"

